/* quoridor 26-08-2015 */
var ai=function(){"use strict"}(),board=function(){"use strict";function a(a){var b,c=[];return b=a%p.boardDimension*2+Math.floor(a/p.boardDimension)*(p.boardDimension-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(p.boardDimension-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}function b(a){return[a-p.boardDimension,a+1,a+p.boardDimension,a-1,a]}function c(a){var c,d=b(a),e=d.slice(),f=h(a);for(c=0;c<f.length;c++)e.splice(e.indexOf(d[f[c]]),1);return e}function d(b,c){var d,e=a(b);for(d=0;d<e.length;d++)if(e[d]===c)switch(d){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function e(a,c){var d,e=b(a);for(d=0;d<e.length;d++)if(e[d]===c)return d;return-1}function f(a,b){var c=[a-p.boardDimension,a+1,a+p.boardDimension,a-1];return i(a,c[b])?c[b]:-1}function g(b,c){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=a(b),g=f.slice(),i=h(b),j=[];for(e=0;e<i.length;e++)switch(i[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(c)return g;for(e=0;e<g.length;e++)-1===p.placedWalls.indexOf(g[e])&&j.push(g[e]);for(e=0;e<j.length;e++)g.splice(g.indexOf(j[e]),1);return g}function h(a){var b,c=[];for(b=0;4>b;b++)-1===f(a,b)&&c.push(b);return c}function i(a,b){var c=e(a,b);switch(c){case 0:return Math.floor(a/p.boardDimension)>0;case 1:return a%p.boardDimension<8;case 2:return Math.floor(a/p.boardDimension)<8;case 3:return a%p.boardDimension>0;default:return!1}}function j(a,b){var h,i,k,l,m,n,o,q=c(a),r=g(a,!1);for(h=0;h<r.length;h++)p.placedWalls.indexOf(r[h])>-1&&(o=d(a,r[h]),q.splice(q.indexOf(f(a,o)),1));if(!b)for(h=0;h<q.length;h++)if(players.getTokenAtPositionIndex(q[h])&&q[h]!==a){for(m=e(a,q[h]),r=g(q[h],!1),i=0;i<r.length;i++)o=d(q[h],r[i]),m===o&&(n=j(q[h],!0));if(n||(l=f(q[h],m),l>-1?q.splice(h,1,l):n=j(q[h],!0)),n){for(k=0;k<n.length;k++)-1===q.indexOf(n[k])&&q.push(n[k]);q.splice(h,1)}}return q}function k(a){var b=a%p.boardDimension,c=Math.floor(a/p.boardDimension);return[b,c]}function l(a){var b=p.borderWidth+p.cellWidth,c=0,d=a[0]%b<=p.borderWidth,e=a[1]%b<=p.borderWidth,f=a[0]>p.borderWidth&&a[1]>p.borderWidth,g=Math.floor(a[0]/b)<p.boardDimension&&Math.floor(a[1]/b)<p.boardDimension;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>p.borderWidth?c+=2*Math.floor(a[1]/b)*(p.boardDimension-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(p.boardDimension-1)),Math.floor(a[0]/b)<p.boardDimension&&(a[0]%b>p.borderWidth||(c+=2*Math.floor(a[0]/b)-1)),Math.floor(a[0]/b)===p.boardDimension-1&&a[0]%b>p.borderWidth?c-=2:Math.floor(a[1]/b)===p.boardDimension-1&&a[1]%b>p.borderWidth&&(c-=2*(p.boardDimension-1)),console.log("index "+c+"\n---------------"),c):d&&e&&p.wallPreview>-1?p.wallPreview:-1}function m(a){var b,c,d=p.borderWidth+p.cellWidth;return console.log("index to wall coors "),a%2===0?(b=p.borderWidth+a%(2*(p.boardDimension-1))/2*d,c=(1+Math.floor(a/(2*(p.boardDimension-1))))*d,console.log("even x "+b+" y "+c)):(console.log("odd "),b=((a%(2*(p.boardDimension-1))-1)/2+1)*d,c=p.borderWidth+Math.floor(a/(2*(p.boardDimension-1)))*d),[b,c]}function n(a){var b=a[0]*p.cellWidth+(a[0]+1)*p.borderWidth,c=a[1]*p.cellWidth+(a[1]+1)*p.borderWidth;return[b,c]}function o(){function a(a,b){p.boardContext.fillStyle=b,p.boardContext.fillRect(a[0],a[1],p.cellWidth,p.cellWidth)}function b(a,b,c){p.boardContext.fillStyle=b,c?p.boardContext.fillRect(a[0],a[1],p.borderWidth,2*p.cellWidth+p.borderWidth):p.boardContext.fillRect(a[0],a[1],2*p.cellWidth+p.borderWidth,p.borderWidth)}var c,d,e,f,g,h,i;for(p.boardContext.fillStyle="black",p.boardContext.fillRect(0,0,p.boardSize,p.boardSize),c=0;c<p.boardDimension;c++)for(d=0;d<p.boardDimension;d++)if(f=p.borderWidth*(d+1)+p.cellWidth*d,g=p.borderWidth*(c+1)+p.cellWidth*c,p.validMoves){for(e=0;e<p.validMoves.length;e++)if(p.validMoves[e][0]===f&&p.validMoves[e][1]===g){a([f,g],"#D8D8D8"),e=p.validMoves.length+1;break}e===p.validMoves.length&&a([f,g],"grey")}else a([f,g],"grey");if(void 0!==p.wallPreview&&p.wallPreview>-1&&(h=m(p.wallPreview),p.wallPreview%2===0?b(h,players.getCurrentPlayer().getColor(),!1):b(h,players.getCurrentPlayer().getColor(),!0)),p.placedWalls.length>0)for(c=0;c<p.placedWalls.length;c++)h=m(p.placedWalls[c]),p.placedWalls[c]%2===0?b(h,"white",!1):b(h,"white",!0);i=players.getTokens(),i&&(i[0].drawToken(p.boardContext),i[1].drawToken(p.boardContext))}var p={placedWalls:[]};return{init:function(a,b){p.cellWidth=a,p.boardDimension=b,p.borderWidth=a/5,p.topStartPos=[Math.floor(p.boardDimension/2),0],p.botStartPos=[Math.floor(p.boardDimension/2),p.boardDimension-1],p.boardSize=p.cellWidth*p.boardDimension+p.borderWidth*(p.boardDimension+1),p.hudCanvas=document.createElement("canvas"),p.hudCanvas.id="hud",p.hudCanvas.height=p.boardSize,p.hudCanvas.width=p.boardSize/3,p.hudContext=p.hudCanvas.getContext("2d"),p.hudContext.fillStyle="black",p.hudContext.fillRect(0,0,p.boardSize/3,p.boardSize),document.body.appendChild(p.hudCanvas),p.boardCanvas=document.createElement("canvas"),p.boardCanvas.id="board",p.boardCanvas.height=p.boardSize,p.boardCanvas.width=p.boardSize,p.boardContext=p.boardCanvas.getContext("2d"),p.boardContext.fillStyle="black",p.boardContext.fillRect(0,0,p.boardSize,p.boardSize),document.body.appendChild(p.boardCanvas)},drawBoard:o,positionIndexToPosition:k,getCanvas:function(){return p.boardCanvas},getContext:function(){return p.boardContext},getDimension:function(){return p.boardDimension},getCellWidth:function(){return p.cellWidth},getBorderWidth:function(){return p.borderWidth},getBotPos:function(){return p.botStartPos},getTopPos:function(){return p.topStartPos},coordinatesToCellPosition:function(a){var b,c,d=p.borderWidth+p.cellWidth,e=Math.floor(a[0]/d),f=Math.floor(a[1]/d);for(c=0;2>c;c++)if(b=a[c]%d,b<=p.borderWidth)return void 0;return[e,f]},coordinatesToWallIndex:l,positionToCellCoordinates:function(a){var b=(a[0]+.5)*p.cellWidth+(a[0]+1)*p.borderWidth,c=(a[1]+.5)*p.cellWidth+(a[1]+1)*p.borderWidth;return[b,c]},positionToRectCellCoordinates:n,setValidMoves:function(a){var b,c=[];if(a){for(b=0;b<a.length;b++)c.push(n(k(a[b])));p.validMoves=c}else p.validMoves=void 0},setWallPreview:function(a){a?(console.log("coor "+a),p.wallPreview=l(a)):p.wallPreview=void 0},getAdjacentWalls:g,getValidMoves:j,isMoveOnBoard:i}}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){function a(a){var b=board.getCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*board.getCanvas().width,d=a.clientY-b.top/(b.bottom-b.top)*board.getCanvas().height;return[c,d]}var b,c,d;board.init(55,9),players.init("human","ai"),board.drawBoard(),board.getCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l,m;for(f=a(e),g=f[0],h=f[1],i=players.getTokens(),j=0;j<i.length;j++)if(k=g-i[j].getX(),l=h-i[j].getY(),k*k+l*l<=Math.pow(i[j].getRadius(),2)){b=i[j],d=k,c=l;break}b&&(m=board.getValidMoves(b.getPositionIndex(),!1),board.setValidMoves(m),board.drawBoard())}),board.getCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):board.setWallPreview(h),board.drawBoard()}),board.getCanvas().addEventListener("mouseup",function(a){b&&(b.updatePosition(),b.updateCoordinates(),board.setValidMoves(void 0),board.drawBoard(),b=void 0)})})}();var players=function(){"use strict";function a(){return[f.player1.getToken(),f.player2.getToken()]}function b(a,b){var c={color:a,token:new e(b,a,this)};this.currentPlayer=function(){return c.currentPlayer},this.getToken=function(){return c.token},this.getColor=function(){return c.color}}function c(a,c){b.apply(this,arguments)}function d(a,c){b.apply(this,arguments)}function e(a,b,c){var d={position:a,color:b,player:c},e=board.getCellWidth();d.x=(d.position[0]+.5)*e+(d.position[0]+1)*board.getBorderWidth(),d.y=(d.position[1]+.5)*e+(d.position[1]+1)*board.getBorderWidth(),d.radius=e/2*.8,this.drawToken=function(a){a.fillStyle=d.color,a.beginPath(),a.arc(d.x,d.y,d.radius,0,2*Math.PI),a.fill()},this.getX=function(){return d.x},this.getY=function(){return d.y},this.setX=function(a){d.x=a},this.setY=function(a){d.y=a},this.setPosition=function(a){d.position=a},this.getRadius=function(){return d.radius},this.setCoordinates=function(a){d.x=a[0],d.y=a[1]},this.getCoordinates=function(){return[d.x,d.y]},this.updatePosition=function(){var a=[d.x,d.y];d.position=board.coordinatesToCellPosition(a)},this.updateCoordinates=function(){var a=board.positionToCellCoordinates(d.position);d.x=a[0],d.y=a[1]},this.getPositionIndex=function(){return d.position[0]+d.position[1]*board.getDimension()},this.getPosition=function(){return d.position}}var f={player1:void 0,player2:void 0,currentPlayer:void 0};return{init:function(a,b){function e(a,b,e){return"human"===a?new c(b,e):new d(b,e)}f.player1=e(a,"red",board.getBotPos()),f.player2=e(b,"blue",board.getTopPos()),f.currentPlayer=f.player1},getPlayer1:function(){return f.player1},getPlayer2:function(){return f.player2},getTokens:a,getTokenAtPositionIndex:function(b){var c,d=a();for(c=0;c<d.length;c++)if(b===d[c].getPositionIndex())return d[c];return void 0},getCurrentPlayer:function(){return f.currentPlayer}}}();