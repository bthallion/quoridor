/* quoridor 27-08-2015 */
var ai=function(){"use strict"}(),board=function(){"use strict";function a(a){var b,c=[];return b=a%s.boardDimension*2+Math.floor(a/s.boardDimension)*(s.boardDimension-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(s.boardDimension-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}function b(a){return[a-s.boardDimension,a+1,a+s.boardDimension,a-1,a]}function c(a){var c,d=b(a),e=d.slice(),f=h(a);for(c=0;c<f.length;c++)e.splice(e.indexOf(d[f[c]]),1);return e}function d(b,c){var d,e=a(b);for(d=0;d<e.length;d++)if(e[d]===c)switch(d){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function e(a,c){var d,e=b(a);for(d=0;d<e.length;d++)if(e[d]===c)return d;return-1}function f(a,b){var c=[a-s.boardDimension,a+1,a+s.boardDimension,a-1];return i(a,c[b])?c[b]:-1}function g(b,c){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=a(b),g=f.slice(),i=h(b),j=[];for(e=0;e<i.length;e++)switch(i[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(c)return g;for(e=0;e<g.length;e++)-1===s.placedWalls.indexOf(g[e])&&j.push(g[e]);for(e=0;e<j.length;e++)g.splice(g.indexOf(j[e]),1);return g}function h(a){var b,c=[];for(b=0;4>b;b++)-1===f(a,b)&&c.push(b);return c}function i(a,b){var c=e(a,b);switch(c){case 0:return Math.floor(a/s.boardDimension)>0;case 1:return a%s.boardDimension<8;case 2:return Math.floor(a/s.boardDimension)<8;case 3:return a%s.boardDimension>0;default:return!1}}function j(a){var b,c;for(c=a%2===0?[a,a+1,a+2,a-2]:[a,a-1,a-2*(s.boardDimension-1),a+2*(s.boardDimension-1)],b=0;b<c.length;b++)if(s.placedWalls.indexOf(c[b])>-1)return console.log("walls intersect"),!0;return!1}function k(a){return!j(a)&&l(a)}function l(a){var b,c=players.getTokens();for(b=0;b<c.length;b++)if(!m(c[b],a))return!1;return!0}function m(a,b){var c,d,e,f=a.getWinRange(),g=[a.getPosition()],h=new Array(Math.pow(s.boardDimension,2)-1).join("0").split("").map(parseFloat);b>-1&&s.placedWalls.push(b);do{if(d=g.shift(),d>=f[0]&&d<=f[1])return s.placedWalls.splice(s.placedWalls.length-1,1),!0;for(e=n(d,!1),c=0;c<e.length;c++)1!==h[e[c]]&&(h[e[c]]=1,g=g.concat(n(e[c])))}while(g.length>0);return s.placedWalls.splice(s.placedWalls.length-1,1),!1}function n(a,b){var h,i,j,k,l,m,o,p=c(a),q=g(a,!1);for(h=0;h<q.length;h++)s.placedWalls.indexOf(q[h])>-1&&(o=d(a,q[h]),p.splice(p.indexOf(f(a,o)),1));if(!b)for(h=0;h<p.length;h++)if(players.getTokenAtPosition(p[h])&&p[h]!==a){for(l=e(a,p[h]),q=g(p[h],!1),i=0;i<q.length;i++)o=d(p[h],q[i]),l===o&&(m=n(p[h],!0));if(m||(k=f(p[h],l),k>-1?p.splice(h,1,k):m=n(p[h],!0)),m){for(j=0;j<m.length;j++)-1===p.indexOf(m[j])&&p.push(m[j]);p.splice(h,1)}}return p}function o(a){var b=s.borderWidth+s.cellWidth,c=0,d=a[0]%b<=s.borderWidth,e=a[1]%b<=s.borderWidth,f=a[0]>s.borderWidth&&a[1]>s.borderWidth,g=Math.floor(a[0]/b)<s.boardDimension&&Math.floor(a[1]/b)<s.boardDimension;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>s.borderWidth?c+=2*Math.floor(a[1]/b)*(s.boardDimension-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(s.boardDimension-1)),Math.floor(a[0]/b)<s.boardDimension&&(c+=a[0]%b>s.borderWidth?2*Math.floor(a[0]/b):2*Math.floor(a[0]/b)-1),Math.floor(a[0]/b)===s.boardDimension-1&&a[0]%b>s.borderWidth?c-=2:Math.floor(a[1]/b)===s.boardDimension-1&&a[1]%b>s.borderWidth&&(c-=2*(s.boardDimension-1)),c):d&&e&&s.wallPreview>-1?s.wallPreview:-1}function p(a){var b,c,d=s.borderWidth+s.cellWidth;return a%2===0?(b=s.borderWidth+a%(2*(s.boardDimension-1))/2*d,c=(1+Math.floor(a/(2*(s.boardDimension-1))))*d):(b=((a%(2*(s.boardDimension-1))-1)/2+1)*d,c=s.borderWidth+Math.floor(a/(2*(s.boardDimension-1)))*d),[b,c]}function q(a){var b=a%s.boardDimension,c=Math.floor(a/s.boardDimension),d=b*s.cellWidth+(b+1)*s.borderWidth,e=c*s.cellWidth+(c+1)*s.borderWidth;return[d,e]}function r(){function a(a,b){s.boardContext.fillStyle=b,s.boardContext.fillRect(a[0],a[1],s.cellWidth,s.cellWidth)}function b(a,b,c){s.boardContext.fillStyle=b,c?s.boardContext.fillRect(a[0],a[1],s.borderWidth,2*s.cellWidth+s.borderWidth):s.boardContext.fillRect(a[0],a[1],2*s.cellWidth+s.borderWidth,s.borderWidth)}var c,d,e,f,g,h,i;for(s.boardContext.fillStyle="black",s.boardContext.fillRect(0,0,s.boardSize,s.boardSize),c=0;c<s.boardDimension;c++)for(d=0;d<s.boardDimension;d++)if(f=s.borderWidth*(d+1)+s.cellWidth*d,g=s.borderWidth*(c+1)+s.cellWidth*c,s.validMoves){for(e=0;e<s.validMoves.length;e++)s.validMoves[e][0]===f&&s.validMoves[e][1]===g&&(a([f,g],"#D8D8D8"),e=s.validMoves.length+1);e===s.validMoves.length&&a([f,g],"grey")}else a([f,g],"grey");if(void 0!==s.wallPreview&&s.wallPreview>-1&&(h=p(s.wallPreview),s.wallPreview%2===0?b(h,players.getCurrentPlayer().getColor(),!1):b(h,players.getCurrentPlayer().getColor(),!0)),s.placedWalls.length>0)for(c=0;c<s.placedWalls.length;c++)h=p(s.placedWalls[c]),s.placedWalls[c]%2===0?b(h,"white",!1):b(h,"white",!0);i=players.getTokens(),i&&(i[0].drawToken(s.boardContext),i[1].drawToken(s.boardContext))}var s={placedWalls:[]};return{init:function(a,b){s.cellWidth=a,s.boardDimension=b,s.borderWidth=a/5,s.topStartPos=Math.floor(s.boardDimension/2),s.botStartPos=Math.floor(s.boardDimension/2)+s.boardDimension*(s.boardDimension-1),s.boardSize=s.cellWidth*s.boardDimension+s.borderWidth*(s.boardDimension+1),s.hudCanvas=document.createElement("canvas"),s.hudCanvas.id="hud",s.hudCanvas.height=s.boardSize,s.hudCanvas.width=s.boardSize/3,s.hudContext=s.hudCanvas.getContext("2d"),s.hudContext.fillStyle="black",s.hudContext.fillRect(0,0,s.boardSize/3,s.boardSize),document.body.appendChild(s.hudCanvas),s.boardCanvas=document.createElement("canvas"),s.boardCanvas.id="board",s.boardCanvas.height=s.boardSize,s.boardCanvas.width=s.boardSize,s.boardContext=s.boardCanvas.getContext("2d"),s.boardContext.fillStyle="black",s.boardContext.fillRect(0,0,s.boardSize,s.boardSize),document.body.appendChild(s.boardCanvas)},drawBoard:r,getCanvas:function(){return s.boardCanvas},getContext:function(){return s.boardContext},getDimension:function(){return s.boardDimension},getCellWidth:function(){return s.cellWidth},getBorderWidth:function(){return s.borderWidth},getBotPos:function(){return s.botStartPos},getTopPos:function(){return s.topStartPos},coordinatesToCellPosition:function(a){var b,c,d=s.borderWidth+s.cellWidth,e=Math.floor(a[0]/d)+Math.floor(a[1]/d)*s.boardDimension;for(c=0;2>c;c++)if(b=a[c]%d,b<=s.borderWidth)return void 0;return e},coordinatesToWallIndex:o,positionToCellCoordinates:function(a){var b=a%s.boardDimension,c=Math.floor(a/s.boardDimension),d=(b+.5)*s.cellWidth+(b+1)*s.borderWidth,e=(c+.5)*s.cellWidth+(c+1)*s.borderWidth;return[d,e]},positionToRectCellCoordinates:q,setValidMoves:function(a){var b,c=[];if(a){for(b=0;b<a.length;b++)c.push(q(a[b]));s.validMoves=c}else s.validMoves=void 0},setWallPreview:function(a){a?s.wallPreview=o(a):s.wallPreview=void 0},getWallPreview:function(){return s.wallPreview>-1?s.wallPreview:void 0},placeWall:function(a){a>-1&&(console.log("ADD perm WALL"),s.placedWalls.push(a))},getAdjacentWalls:g,getValidMoves:n,isMoveOnBoard:i,isWallValid:k}}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){function a(a){var b=board.getCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*board.getCanvas().width,d=a.clientY-b.top/(b.bottom-b.top)*board.getCanvas().height;return[c,d]}var b,c,d;board.init(55,9),players.init("human","ai"),board.drawBoard(),board.getCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l,m,n;for(f=a(e),g=f[0],h=f[1],i=players.getTokens(),j=0;j<i.length;j++)if(k=g-i[j].getX(),l=h-i[j].getY(),k*k+l*l<=Math.pow(i[j].getRadius(),2)){b=i[j],d=k,c=l;break}n=board.getWallPreview(),b?(m=board.getValidMoves(b.getPosition(),!1),board.setValidMoves(m),board.drawBoard()):n>-1&&board.isWallValid(n)&&(board.placeWall(n),board.drawBoard())}),board.getCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):board.setWallPreview(h),board.drawBoard()}),board.getCanvas().addEventListener("mouseup",function(a){b&&(b.updatePosition(),b.updateCoordinates(),board.setValidMoves(void 0),board.drawBoard(),b=void 0)})})}();var players=function(){"use strict";function a(){return[g.player1.getToken(),g.player2.getToken()]}function b(a){return console.log("win range condition for "+a+" "+(0===Math.floor(a/board.getDimension()))),0===Math.floor(a/board.getDimension())?[board.getDimension()*(board.getDimension()-1),Math.pow(board.getDimension(),2)-1]:[0,board.getDimension()-1]}function c(a,b,c){var d={color:a,token:new f(b,c,a,this),acted:!1};this.getToken=function(){return d.token},this.getColor=function(){return d.color},this.acted=function(){d.acted=!d.acted}}function d(a,b){c.apply(this,arguments)}function e(a,b){c.apply(this,arguments)}function f(a,b,c,d){var e={position:a,color:c,player:d,winRange:b},f=board.getCellWidth(),g=board.positionToCellCoordinates(e.position);e.x=g[0],e.y=g[1],e.radius=f/2*.8,this.drawToken=function(a){a.fillStyle=e.color,a.beginPath(),a.arc(e.x,e.y,e.radius,0,2*Math.PI),a.fill()},this.getX=function(){return e.x},this.getY=function(){return e.y},this.setX=function(a){e.x=a},this.setY=function(a){e.y=a},this.setPosition=function(a){e.position=a},this.getRadius=function(){return e.radius},this.setCoordinates=function(a){e.x=a[0],e.y=a[1]},this.getCoordinates=function(){return[e.x,e.y]},this.updatePosition=function(){var a,b=[e.x,e.y];a=board.coordinatesToCellPosition(b),a!==e.position&&(e.player.acted(),e.position=a)},this.updateCoordinates=function(){var a=board.positionToCellCoordinates(e.position);e.x=a[0],e.y=a[1]},this.getPosition=function(){return e.position},this.getWinRange=function(){return e.winRange}}var g={player1:void 0,player2:void 0,currentPlayer:void 0};return{init:function(a,c){function f(a,c,f){return"human"===a?new d(c,f,b(f)):new e(c,f,b(f))}g.player1=f(a,"red",board.getBotPos()),g.player2=f(c,"blue",board.getTopPos()),g.currentPlayer=g.player1},getPlayer1:function(){return g.player1},getPlayer2:function(){return g.player2},getTokens:a,getTokenAtPosition:function(b){var c,d=a();for(c=0;c<d.length;c++)if(b===d[c].getPosition())return d[c];return void 0},getCurrentPlayer:function(){return g.currentPlayer},nextPlayer:function(){g.currentPlayer=g.currentPlayer===g.player1?g.player2:g.player1}}}();