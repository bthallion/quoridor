/* quoridor 27-08-2015 */
var ai=function(){"use strict"}(),board=function(){"use strict";function a(a){var b,c=[];return b=a%u.boardDimension*2+Math.floor(a/u.boardDimension)*(u.boardDimension-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(u.boardDimension-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}function b(a){return[a-u.boardDimension,a+1,a+u.boardDimension,a-1,a]}function c(a){var c,d=b(a),e=d.slice(),f=h(a);for(c=0;c<f.length;c++)e.splice(e.indexOf(d[f[c]]),1);return e}function d(b,c){var d,e=a(b);for(d=0;d<e.length;d++)if(e[d]===c)switch(d){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function e(a,c){var d,e=b(a);for(d=0;d<e.length;d++)if(e[d]===c)return d;return-1}function f(a,b){var c=[a-u.boardDimension,a+1,a+u.boardDimension,a-1];return i(a,c[b])?c[b]:-1}function g(b,c){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=a(b),g=f.slice(),i=h(b),j=[];for(e=0;e<i.length;e++)switch(i[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(c===!0)return g;for(e=0;e<g.length;e++)-1===u.placedWalls.indexOf(g[e])&&j.push(g[e]);for(e=0;e<j.length;e++)g.splice(g.indexOf(j[e]),1);return g}function h(a){var b,c=[];for(b=0;4>b;b++)-1===f(a,b)&&c.push(b);return c}function i(a,b){var c=e(a,b);switch(c){case 0:return Math.floor(a/u.boardDimension)>0;case 1:return a%u.boardDimension<8;case 2:return Math.floor(a/u.boardDimension)<8;case 3:return a%u.boardDimension>0;default:return!1}}function j(a){var b,c;for(a%2===0?(c=[a,a+1,a+2,a-2],a%(2*(u.boardDimension-1))===2*(u.boardDimension-1)-2&&c.splice(2,1),a%(2*(u.boardDimension-1))===0&&c.splice(3,1)):c=[a,a-1,a-2*(u.boardDimension-1),a+2*(u.boardDimension-1)],b=0;b<c.length;b++)if(u.placedWalls.indexOf(c[b])>-1)return!0;return!1}function k(a){return a>-1&&!j(a)&&m(a)}function l(a){return"undefined"!=typeof u.validMoves?-1!==u.validMoves.indexOf(a):!1}function m(a){var b,c=players.getTokens();for(b=0;b<c.length;b++)if(!n(c[b],a))return!1;return!0}function n(a,b){var c,d,e,f=a.getWinRange(),g=[a.getPosition()],h=new Array(Math.pow(u.boardDimension,2)-1).join("0").split("").map(parseFloat);b>-1&&u.placedWalls.push(b);do{if(d=g.shift(),d>=f[0]&&d<=f[1])return u.placedWalls.splice(u.placedWalls.length-1,1),!0;for(e=o(d,!1),c=0;c<e.length;c++)1!==h[e[c]]&&(h[e[c]]=1,g=g.concat(o(e[c])))}while(g.length>0);return u.placedWalls.splice(u.placedWalls.length-1,1),!1}function o(a,b){var h,i,j,k,l,m,n,p=c(a),q=g(a,!1);for(h=0;h<q.length;h++)u.placedWalls.indexOf(q[h])>-1&&(n=d(a,q[h]),p.splice(p.indexOf(f(a,n)),1));if(b===!1)for(h=0;h<p.length;h++)if("undefined"!=typeof players.getTokenAtPosition(p[h])&&p[h]!==a){for(l=e(a,p[h]),q=g(p[h],!1),i=0;i<q.length;i++)n=d(p[h],q[i]),l===n&&(m=o(p[h],!0));if("undefined"==typeof m&&(k=f(p[h],l),k>-1?p.splice(h,1,k):m=o(p[h],!0)),"undefined"!=typeof m){for(j=0;j<m.length;j++)-1===p.indexOf(m[j])&&p.push(m[j]);p.splice(h,1)}}return p}function p(a){var b=u.borderWidth+u.cellWidth,c=0,d=a[0]%b<=u.borderWidth,e=a[1]%b<=u.borderWidth,f=a[0]>u.borderWidth&&a[1]>u.borderWidth,g=Math.floor(a[0]/b)<u.boardDimension&&Math.floor(a[1]/b)<u.boardDimension;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>u.borderWidth?c+=2*Math.floor(a[1]/b)*(u.boardDimension-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(u.boardDimension-1)),Math.floor(a[0]/b)<u.boardDimension&&(c+=a[0]%b>u.borderWidth?2*Math.floor(a[0]/b):2*Math.floor(a[0]/b)-1),Math.floor(a[0]/b)===u.boardDimension-1&&a[0]%b>u.borderWidth?c-=2:Math.floor(a[1]/b)===u.boardDimension-1&&a[1]%b>u.borderWidth&&(c-=2*(u.boardDimension-1)),c):d&&e&&u.wallPreview>-1?u.wallPreview:-1}function q(a){var b,c,d=u.borderWidth+u.cellWidth;return a%2===0?(b=u.borderWidth+a%(2*(u.boardDimension-1))/2*d,c=(1+Math.floor(a/(2*(u.boardDimension-1))))*d):(b=((a%(2*(u.boardDimension-1))-1)/2+1)*d,c=u.borderWidth+Math.floor(a/(2*(u.boardDimension-1)))*d),[b,c]}function r(a){var b=a%u.boardDimension,c=Math.floor(a/u.boardDimension),d=b*u.cellWidth+(b+1)*u.borderWidth,e=c*u.cellWidth+(c+1)*u.borderWidth;return[d,e]}function s(){var a,b=[];if("undefined"==typeof u.validMoves)return void 0;for(a=0;a<u.validMoves.length;a++)b.push(r(u.validMoves[a]));return b}function t(){function a(a,b){u.boardContext.fillStyle=b,u.boardContext.fillRect(a[0],a[1],u.cellWidth,u.cellWidth)}function b(a,b,c){u.boardContext.fillStyle=b,c===!0?u.boardContext.fillRect(a[0],a[1],u.borderWidth,2*u.cellWidth+u.borderWidth):u.boardContext.fillRect(a[0],a[1],2*u.cellWidth+u.borderWidth,u.borderWidth)}var c,d,e,f,g,h,i,j;for(u.boardContext.fillStyle="black",u.boardContext.fillRect(0,0,u.boardSize,u.boardSize),c=0;c<u.boardDimension;c++)for(d=0;d<u.boardDimension;d++)if(f=u.borderWidth*(d+1)+u.cellWidth*d,g=u.borderWidth*(c+1)+u.cellWidth*c,j=s(),"undefined"!=typeof j){for(e=0;e<j.length;e++)j[e][0]===f&&j[e][1]===g&&(a([f,g],"#D8D8D8"),e=j.length+1);e===j.length&&a([f,g],"grey")}else a([f,g],"grey");if("undefined"!=typeof u.wallPreview&&u.wallPreview>-1&&(h=q(u.wallPreview),u.wallPreview%2===0?b(h,players.getCurrentPlayer().getColor(),!1):b(h,players.getCurrentPlayer().getColor(),!0)),u.placedWalls.length>0)for(c=0;c<u.placedWalls.length;c++)h=q(u.placedWalls[c]),u.placedWalls[c]%2===0?b(h,"white",!1):b(h,"white",!0);i=players.getTokens(),"undefined"!=typeof i&&(i[0].drawToken(u.boardContext),i[1].drawToken(u.boardContext))}var u={placedWalls:[]};return{init:function(a,b){u.cellWidth=a,u.boardDimension=b,u.borderWidth=a/5,u.topStartPos=Math.floor(u.boardDimension/2),u.botStartPos=Math.floor(u.boardDimension/2)+u.boardDimension*(u.boardDimension-1),u.boardSize=u.cellWidth*u.boardDimension+u.borderWidth*(u.boardDimension+1),u.hudCanvas=document.createElement("canvas"),u.hudCanvas.id="hud",u.hudCanvas.height=u.boardSize,u.hudCanvas.width=u.boardSize/3,u.hudContext=u.hudCanvas.getContext("2d"),u.hudContext.fillStyle="black",u.hudContext.fillRect(0,0,u.boardSize/3,u.boardSize),document.body.appendChild(u.hudCanvas),u.boardCanvas=document.createElement("canvas"),u.boardCanvas.id="board",u.boardCanvas.height=u.boardSize,u.boardCanvas.width=u.boardSize,u.boardContext=u.boardCanvas.getContext("2d"),u.boardContext.fillStyle="black",u.boardContext.fillRect(0,0,u.boardSize,u.boardSize),document.body.appendChild(u.boardCanvas)},drawBoard:t,getCanvas:function(){return u.boardCanvas},getContext:function(){return u.boardContext},getDimension:function(){return u.boardDimension},getCellWidth:function(){return u.cellWidth},getBorderWidth:function(){return u.borderWidth},getBotPos:function(){return u.botStartPos},getTopPos:function(){return u.topStartPos},coordinatesToCellPosition:function(a){var b,c,d=u.borderWidth+u.cellWidth,e=Math.floor(a[0]/d)+Math.floor(a[1]/d)*u.boardDimension;for(c=0;2>c;c++)if(b=a[c]%d,b<=u.borderWidth)return void 0;return e},coordinatesToWallIndex:p,positionToCellCoordinates:function(a){var b=a%u.boardDimension,c=Math.floor(a/u.boardDimension),d=(b+.5)*u.cellWidth+(b+1)*u.borderWidth,e=(c+.5)*u.cellWidth+(c+1)*u.borderWidth;return[d,e]},positionToRectCellCoordinates:r,setValidMovePositions:function(a){"undefined"!=typeof a?u.validMoves=a.slice():u.validMoves=void 0},getValidMovePositions:function(){return u.validMoves},getValidMoveCoordinates:s,setWallPreview:function(a){a.constructor===Array?u.wallPreview=p(a):u.wallPreview=void 0},getWallPreview:function(){return u.wallPreview>-1?u.wallPreview:void 0},placeWall:function(a){a>-1&&u.placedWalls.push(a)},getAdjacentWalls:g,findValidMovePositions:o,isMoveOnBoard:i,isWallValid:k,isMoveValid:l}}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){function a(a){var b=board.getCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*board.getCanvas().width,d=(a.clientY-b.top)/(b.bottom-b.top)*board.getCanvas().height;return[c,d]}var b,c,d;board.init(55,9),players.init("human","ai"),board.drawBoard(),board.getCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l,m;f=a(e),g=f[0],h=f[1],i=players.getCurrentPlayer().getToken(),j=g-i.getX(),k=h-i.getY(),j*j+k*k<=Math.pow(i.getRadius(),2)&&(b=i,d=j,c=k),m=board.getWallPreview(),"undefined"!=typeof b?(l=board.findValidMovePositions(b.getPosition(),!1),console.log("moves "+l),board.setValidMovePositions(l),board.drawBoard()):board.isWallValid(m)&&(board.placeWall(m),players.getCurrentPlayer().act(),board.drawBoard())}),board.getCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);"undefined"!=typeof b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):board.setWallPreview(h),board.drawBoard()}),board.getCanvas().addEventListener("mouseup",function(a){"undefined"!=typeof b&&(b.updatePosition(),b.updateCoordinates(),b=void 0,board.setValidMovePositions(void 0),board.drawBoard()),players.getCurrentPlayer().hasActed()&&players.nextPlayer()})})}();var players=function(){"use strict";function a(){return[g.player1.getToken(),g.player2.getToken()]}function b(a){return 0===Math.floor(a/board.getDimension())?[board.getDimension()*(board.getDimension()-1),Math.pow(board.getDimension(),2)-1]:[0,board.getDimension()-1]}function c(a,b,c){var d={color:a,token:new f(b,c,a,this),hasActed:!1};this.getToken=function(){return d.token},this.getColor=function(){return d.color},this.act=function(){d.hasActed=!d.hasActed},this.hasActed=function(){return d.hasActed}}function d(a,b){c.apply(this,arguments)}function e(a,b){c.apply(this,arguments)}function f(a,b,c,d){var e={position:a,color:c,player:d,winRange:b},f=board.getCellWidth(),g=board.positionToCellCoordinates(e.position);e.x=g[0],e.y=g[1],e.radius=f/2*.8,this.drawToken=function(a){a.fillStyle=e.color,a.beginPath(),a.arc(e.x,e.y,e.radius,0,2*Math.PI),a.fill()},this.getX=function(){return e.x},this.getY=function(){return e.y},this.setX=function(a){e.x=a},this.setY=function(a){e.y=a},this.setPosition=function(a){e.position=a},this.getRadius=function(){return e.radius},this.setCoordinates=function(a){e.x=a[0],e.y=a[1]},this.getCoordinates=function(){return[e.x,e.y]},this.updatePosition=function(){var a,b=[e.x,e.y];a=board.coordinatesToCellPosition(b),a!==e.position&&board.isMoveValid(a)&&(e.player.act(),e.position=a)},this.updateCoordinates=function(){var a=board.positionToCellCoordinates(e.position);e.x=a[0],e.y=a[1]},this.getPosition=function(){return e.position},this.getWinRange=function(){return e.winRange}}var g={player1:void 0,player2:void 0,currentPlayer:void 0};return{init:function(a,c){function f(a,c,f){return"human"===a?new d(c,f,b(f)):new e(c,f,b(f))}g.player1=f(a,"red",board.getBotPos()),g.player2=f(c,"blue",board.getTopPos()),g.currentPlayer=g.player1},getPlayer1:function(){return g.player1},getPlayer2:function(){return g.player2},getTokens:a,getTokenAtPosition:function(b){var c,d=a();for(c=0;c<d.length;c++)if(b===d[c].getPosition())return d[c];return void 0},getCurrentPlayer:function(){return g.currentPlayer},nextPlayer:function(){g.currentPlayer.act(),g.currentPlayer=g.currentPlayer===g.player1?g.player2:g.player1}}}();