/* quoridor 04-09-2015 */
function boardConstructor(a){function b(){var b;t.placedWalls=[],t.validMoves=[];for(b in a)a.hasOwnProperty(b)&&(t[b]=a[b])}function c(a){var b,c=[];for(b=0;4>b;b++)-1===n(a,b)&&c.push(b);return c}function d(a,b){var c=o(a,b);switch(c){case 0:return Math.floor(a/global.BOARD_DIMENSION)>0;case 1:return a%global.BOARD_DIMENSION<8;case 2:return Math.floor(a/global.BOARD_DIMENSION)<8;case 3:return a%global.BOARD_DIMENSION>0;default:return!1}}function e(a){var b,c;for(a%2===0?(c=[a,a+1,a+2,a-2],a%(2*(global.BOARD_DIMENSION-1))===2*(global.BOARD_DIMENSION-1)-2&&c.splice(2,1),a%(2*(global.BOARD_DIMENSION-1))===0&&c.splice(3,1)):c=[a,a-1,a-2*(global.BOARD_DIMENSION-1),a+2*(global.BOARD_DIMENSION-1)],b=0;b<c.length;b++)if(t.placedWalls.indexOf(c[b])>-1)return!0;return!1}function f(a){return a>-1&&!e(a)&&h(a)}function g(a){return t.validMoves.length>0?-1!==t.validMoves.indexOf(a):!1}function h(b){var c,d;for(d=a.simulated!==!1?[a.token1,a.token2]:players.getTokens(),c=0;c<d.length;c++)if(!i(d[c],b))return!1;return!0}function i(a,b){var c,d,e,f=a.getWinRange(),g=[a.getPosition()],h=new Array(Math.pow(global.BOARD_DIMENSION,2)-1).join("0").split("").map(parseFloat);b>-1&&t.placedWalls.push(b);do{if(d=g.shift(),d>=f[0]&&d<=f[1])return t.placedWalls.splice(t.placedWalls.length-1,1),!0;for(e=k(d,!1,!0),c=0;c<e.length;c++)1!==h[e[c]]&&(h[e[c]]=1,g=g.concat(k(e[c],!1,!0)))}while(g.length>0);return t.placedWalls.splice(t.placedWalls.length-1,1),!1}function j(b){var c,d;for(c=a.simulated?[a.token1,a.token2]:players.getTokens(),d=0;d<c.length;d++)if(b===c[d].getPosition())return c[d];return void 0}function k(a,b,c){var d,e,f,g,h,i,r,s=q(a),u=m(a,!1);for(d=0;d<u.length;d++)t.placedWalls.indexOf(u[d])>-1&&(r=p(a,u[d]),s.splice(s.indexOf(n(a,r)),1));if(b===!1)for(d=0;d<s.length;d++)if("undefined"!=typeof j(s[d])&&s[d]!==a){for(h=o(a,s[d]),u=m(s[d],!1),e=0;e<u.length;e++)r=p(s[d],u[e]),h===r&&(i=k(s[d],!0,!0));if("undefined"==typeof i&&(g=n(s[d],h),g>-1?s.splice(d,1,g):i=k(s[d],!0,!0)),"undefined"!=typeof i){for(f=0;f<i.length;f++)-1===s.indexOf(i[f])&&s.push(i[f]);s.splice(d,1)}}return c===!0?s:void l(s)}function l(a){a.constructor===Array?t.validMoves=a.slice():t.validMoves=[]}function m(a,b){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=s(a),g=f.slice(),h=c(a),i=[];for(e=0;e<h.length;e++)switch(h[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(b===!0)return g;for(e=0;e<g.length;e++)-1===t.placedWalls.indexOf(g[e])&&i.push(g[e]);for(e=0;e<i.length;e++)g.splice(g.indexOf(i[e]),1);return g}function n(a,b){var c=[a-global.BOARD_DIMENSION,a+1,a+global.BOARD_DIMENSION,a-1];return d(a,c[b])?c[b]:-1}function o(a,b){var c,d=r(a);for(c=0;c<d.length;c++)if(d[c]===b)return c;return-1}function p(a,b){var c,d=s(a);for(c=0;c<d.length;c++)if(d[c]===b)switch(c){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function q(a){var b,d=r(a),e=d.slice(),f=c(a);for(b=0;b<f.length;b++)e.splice(e.indexOf(d[f[b]]),1);return e}function r(a){return[a-global.BOARD_DIMENSION,a+1,a+global.BOARD_DIMENSION,a-1,a]}function s(a){var b,c=[];return b=a%global.BOARD_DIMENSION*2+Math.floor(a/global.BOARD_DIMENSION)*(global.BOARD_DIMENSION-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(global.BOARD_DIMENSION-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}var t={};return b(),{placeWall:function(a){a>-1&&t.placedWalls.push(a)},getBoardString:function(){return JSON.stringify(t)},getValidMoves:function(){return t.validMoves},setValidMoves:l,findValidMoves:k,wallIsValid:f,moveIsValid:g,getPlacedWalls:function(){return t.placedWalls}}}var ai=function(){"use strict";function a(){var a={method:"GET",mode:"cors",cache:"default"};window.fetch("treehash",a).then(d).then(function(a){return a.json()}).then(function(a){c=new b(a)})}function b(a){var b;b="object"==typeof a?JSON.parse(JSON.stringify(a)):{totalSimulations:0},this.getItem=function(a){return b[a]},this.setItem=function(a,c){var d;return"undefined"!=typeof b[a]?b[a]=c:(d=b[a],b[a]=c),d},this.hasItem=function(a){return"undefined"!=typeof b[a]}}var c,d=function(a,b){return console.log(a),200===a.status||0===a.status?Promise.resolve(a):Promise.reject(b)};a()}(),board,GUI=function(){"use strict";function a(a){var b=global.BORDER_WIDTH+global.CELL_WIDTH,c=0,d=a[0]%b<=global.BORDER_WIDTH,e=a[1]%b<=global.BORDER_WIDTH,f=a[0]>global.BORDER_WIDTH&&a[1]>global.BORDER_WIDTH,g=Math.floor(a[0]/b)<global.BOARD_DIMENSION&&Math.floor(a[1]/b)<global.BOARD_DIMENSION;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>global.BORDER_WIDTH?c+=2*Math.floor(a[1]/b)*(global.BOARD_DIMENSION-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(global.BOARD_DIMENSION-1)),Math.floor(a[0]/b)<global.BOARD_DIMENSION&&(c+=a[0]%b>global.BORDER_WIDTH?2*Math.floor(a[0]/b):2*Math.floor(a[0]/b)-1),Math.floor(a[0]/b)===global.BOARD_DIMENSION-1&&a[0]%b>global.BORDER_WIDTH?c-=2:Math.floor(a[1]/b)===global.BOARD_DIMENSION-1&&a[1]%b>global.BORDER_WIDTH&&(c-=2*(global.BOARD_DIMENSION-1)),c):d&&e&&j.wallPreview>-1?j.wallPreview:-1}function b(a){var b,c,d=global.BORDER_WIDTH+global.CELL_WIDTH;return a%2===0?(b=global.BORDER_WIDTH+a%(2*(global.BOARD_DIMENSION-1))/2*d,c=(1+Math.floor(a/(2*(global.BOARD_DIMENSION-1))))*d):(b=((a%(2*(global.BOARD_DIMENSION-1))-1)/2+1)*d,c=global.BORDER_WIDTH+Math.floor(a/(2*(global.BOARD_DIMENSION-1)))*d),[b,c]}function c(a){var b=a%global.BOARD_DIMENSION,c=Math.floor(a/global.BOARD_DIMENSION),d=b*global.CELL_WIDTH+(b+1)*global.BORDER_WIDTH,e=c*global.CELL_WIDTH+(c+1)*global.BORDER_WIDTH;return[d,e]}function d(){var a,b=[],d=board.getValidMoves();if("undefined"==typeof d)return void 0;for(a=0;a<d.length;a++)b.push(c(d[a]));return b}function e(){var a,b,c,d=players.getPlayer1().getWallCount(),e=players.getPlayer2().getWallCount();for(j.hudContext.fillStyle="black",j.hudContext.fillRect(0,0,global.BOARD_SIZE/3,global.BOARD_SIZE),c=0;e>c;c++)a=global.BORDER_WIDTH+c%5*2*global.BORDER_WIDTH,b=2.5*global.CELL_WIDTH*(.3+Math.floor(c/5)),f([a,b],j.hudContext,players.getPlayer2().getColor(),!0);for(c=0;d>c;c++)a=global.BORDER_WIDTH+c%5*2*global.BORDER_WIDTH,b=5*global.CELL_WIDTH+2.5*global.CELL_WIDTH*(.3+Math.floor(c/5)),f([a,b],j.hudContext,players.getPlayer1().getColor(),!0)}function f(a,b,c,d){b.fillStyle=c,d===!0?b.fillRect(a[0],a[1],global.BORDER_WIDTH,2*global.CELL_WIDTH+global.BORDER_WIDTH):b.fillRect(a[0],a[1],2*global.CELL_WIDTH+global.BORDER_WIDTH,global.BORDER_WIDTH)}function g(a){var b=a.getX(),c=a.getY(),d=a.getRadius();j.boardContext.fillStyle=a.getColor(),j.boardContext.beginPath(),j.boardContext.arc(b,c,d,0,2*Math.PI),j.boardContext.fill()}function h(){function a(a,b){j.boardContext.fillStyle=b,j.boardContext.fillRect(a[0],a[1],global.CELL_WIDTH,global.CELL_WIDTH)}var c,e,h,i,k,l,m,n,o=board.getPlacedWalls();for(j.boardContext.fillStyle="black",j.boardContext.fillRect(0,0,global.BOARD_SIZE,global.BOARD_SIZE),c=0;c<global.BOARD_DIMENSION;c++)for(e=0;e<global.BOARD_DIMENSION;e++)if(i=global.BORDER_WIDTH*(e+1)+global.CELL_WIDTH*e,k=global.BORDER_WIDTH*(c+1)+global.CELL_WIDTH*c,n=d(),"undefined"!=typeof n){for(h=0;h<n.length;h++)n[h][0]===i&&n[h][1]===k&&(a([i,k],"#D8D8D8"),h=n.length+1);h===n.length&&a([i,k],"grey")}else a([i,k],"grey");if(j.wallPreview>-1&&(l=b(j.wallPreview),j.wallPreview%2===0?f(l,j.boardContext,players.getCurrentPlayer().getColor(),!1):f(l,j.boardContext,players.getCurrentPlayer().getColor(),!0)),o.length>0)for(c=0;c<o.length;c++)l=b(o[c]),o[c]%2===0?f(l,j.boardContext,"white",!1):f(l,j.boardContext,"white",!0);m=players.getTokens(),g(m[0]),g(m[1])}function i(){h(),e()}var j={};return{init:function(){j.hudCanvas=document.createElement("canvas"),j.hudCanvas.id="hud",j.hudCanvas.height=global.BOARD_SIZE,j.hudCanvas.width=global.BOARD_SIZE/3,j.hudContext=j.hudCanvas.getContext("2d"),j.hudContext.fillStyle="black",j.hudContext.fillRect(0,0,global.BOARD_SIZE/3,global.BOARD_SIZE),document.body.appendChild(j.hudCanvas),j.boardCanvas=document.createElement("canvas"),j.boardCanvas.id="board",j.boardCanvas.height=global.BOARD_SIZE,j.boardCanvas.width=global.BOARD_SIZE,j.boardContext=j.boardCanvas.getContext("2d"),j.boardContext.fillStyle="black",j.boardContext.fillRect(0,0,global.BOARD_SIZE,global.BOARD_SIZE),document.body.appendChild(j.boardCanvas),j.wallPreview=-1,i()},update:i,getBoardCanvas:function(){return j.boardCanvas},getBoardContext:function(){return j.boardContext},coordinatesToCellPosition:function(a){var b,c,d=global.BORDER_WIDTH+global.CELL_WIDTH,e=Math.floor(a[0]/d)+Math.floor(a[1]/d)*global.BOARD_DIMENSION;for(c=0;2>c;c++)if(b=a[c]%d,b<=global.BORDER_WIDTH)return void 0;return e},coordinatesToWallIndex:a,positionToCellCoordinates:function(a){var b=a%global.BOARD_DIMENSION,c=Math.floor(a/global.BOARD_DIMENSION),d=(b+.5)*global.CELL_WIDTH+(b+1)*global.BORDER_WIDTH,e=(c+.5)*global.CELL_WIDTH+(c+1)*global.BORDER_WIDTH;return[d,e]},getWallPreview:function(){return j.wallPreview},setWallPreview:function(a){a>-1?j.wallPreview=a:j.wallPreview=-1},positionToRectCellCoordinates:c,getValidMoveCoordinates:d}}(),global={};!function(){"use strict";function a(a){var b=GUI.getBoardCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*GUI.getBoardCanvas().width,d=(a.clientY-b.top)/(b.bottom-b.top)*GUI.getBoardCanvas().height;return[c,d]}global.BOARD_DIMENSION=9,global.CELL_WIDTH=55,global.BORDER_WIDTH=global.CELL_WIDTH/5,global.BOARD_SIZE=global.CELL_WIDTH*global.BOARD_DIMENSION+global.BORDER_WIDTH*(global.BOARD_DIMENSION+1),global.TOP_START_POS=Math.floor(global.BOARD_DIMENSION/2),global.BOT_START_POS=Math.floor(global.BOARD_DIMENSION/2)+global.BOARD_DIMENSION*(global.BOARD_DIMENSION-1),document.addEventListener("DOMContentLoaded",function(){var b,c,d;board=boardConstructor({simulated:!1}),players.init("human","ai"),GUI.init(),GUI.getBoardCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l;f=a(e),g=f[0],h=f[1],i=players.getCurrentPlayer().getToken(),j=g-i.getX(),k=h-i.getY(),j*j+k*k<=Math.pow(i.getRadius(),2)&&(b=i,d=j,c=k),l=GUI.getWallPreview(),"undefined"!=typeof b?(board.findValidMoves(b.getPosition(),!1,!1),GUI.update()):board.wallIsValid(l)&&(board.placeWall(l),players.getCurrentPlayer().act(),players.getCurrentPlayer().useWall(),GUI.update())}),GUI.getBoardCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);"undefined"!=typeof b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):GUI.setWallPreview(GUI.coordinatesToWallIndex(h)),GUI.update()}),GUI.getBoardCanvas().addEventListener("mouseup",function(a){"undefined"!=typeof b&&(b.updatePosition(),b.updateCoordinates(),b=void 0,board.setValidMoves([]),GUI.update()),players.getCurrentPlayer().hasActed()&&players.nextPlayer()})})}();var players=function(){"use strict";function a(){return[g.player1.getToken(),g.player2.getToken()]}function b(a){return 0===Math.floor(a/global.BOARD_DIMENSION)?[global.BOARD_DIMENSION*(global.BOARD_DIMENSION-1),Math.pow(global.BOARD_DIMENSION,2)-1]:[0,global.BOARD_DIMENSION-1]}function c(a,b,c){var d={index:b,color:a,token:new f(a,this,c),hasActed:!1,wallCount:g.startingWalls};this.getToken=function(){return d.token},this.getColor=function(){return d.color},this.act=function(){d.hasActed=!d.hasActed},this.hasActed=function(){return d.hasActed},this.getIndex=function(){return d.index},this.getWallCount=function(){return d.wallCount},this.useWall=function(){d.wallCount--}}function d(a,b,d){c.apply(this,arguments)}function e(a,b,d){c.apply(this,arguments)}function f(a,c,d){var e={position:d,color:a,player:c,winRange:b(d)},f=GUI.positionToCellCoordinates(e.position);e.x=f[0],e.y=f[1],e.radius=global.CELL_WIDTH/2*.8,this.getX=function(){return e.x},this.getY=function(){return e.y},this.setX=function(a){e.x=a},this.setY=function(a){e.y=a},this.setPosition=function(a){e.position=a},this.getRadius=function(){return e.radius},this.setCoordinates=function(a){e.x=a[0],e.y=a[1]},this.getCoordinates=function(){return[e.x,e.y]},this.updatePosition=function(){var a,b=[e.x,e.y];a=GUI.coordinatesToCellPosition(b),a!==e.position&&board.moveIsValid(a)&&(e.player.act(),e.position=a)},this.updateCoordinates=function(){var a=GUI.positionToCellCoordinates(e.position);e.x=a[0],e.y=a[1]},this.getPosition=function(){return e.position},this.getWinRange=function(){return e.winRange},this.getColor=function(){return e.color}}var g={player1:void 0,player2:void 0,currentPlayer:void 0,startingWalls:10};return{init:function(a,b){function c(a,b,c,f){return"human"===a?new d(b,c,f):new e(b,c,f)}g.player1=c(a,"red",0,global.BOT_START_POS),g.player2=c(b,"blue",1,global.TOP_START_POS),g.currentPlayer=g.player1},getPlayer1:function(){return g.player1},getPlayer2:function(){return g.player2},getTokens:a,getCurrentPlayer:function(){return g.currentPlayer},nextPlayer:function(){g.currentPlayer.act(),g.currentPlayer=g.currentPlayer===g.player1?g.player2:g.player1}}}();