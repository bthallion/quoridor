/* quoridor 13-09-2015 */
function boardConstructor(a){function b(){var b;if(t.placedWalls=[],t.validMoves=[],a)for(b in a)a.hasOwnProperty(b)&&(t[b]=a[b])}function c(a){var b,c=[];for(b=0;4>b;b++)-1===n(a,b)&&c.push(b);return c}function d(a,b){var c=o(a,b);switch(c){case 0:return Math.floor(a/gameSpecs.BOARD_DIMENSION)>0;case 1:return a%gameSpecs.BOARD_DIMENSION<8;case 2:return Math.floor(a/gameSpecs.BOARD_DIMENSION)<8;case 3:return a%gameSpecs.BOARD_DIMENSION>0;default:return!1}}function e(a){var b,c;for(a%2===0?(c=[a,a+1,a+2,a-2],a%(2*(gameSpecs.BOARD_DIMENSION-1))===2*(gameSpecs.BOARD_DIMENSION-1)-2&&c.splice(2,1),a%(2*(gameSpecs.BOARD_DIMENSION-1))===0&&c.splice(3,1)):c=[a,a-1,a-2*(gameSpecs.BOARD_DIMENSION-1),a+2*(gameSpecs.BOARD_DIMENSION-1)],b=0;b<c.length;b++)if(t.placedWalls.indexOf(c[b])>-1)return!0;return!1}function f(a){return a>-1&&!e(a)&&h(a)}function g(a){return t.validMoves.length>0?-1!==t.validMoves.indexOf(a):!1}function h(a){var b,c;for(c=players.getTokens(),b=0;b<c.length;b++)if(!i(c[b],a))return!1;return!0}function i(a,b){var c,d,e,f=a.getWinRange(),g=[a.getPosition()],h=new Array(Math.pow(gameSpecs.BOARD_DIMENSION,2)-1).join("0").split("").map(parseFloat);b>-1&&t.placedWalls.push(b);do{if(d=g.shift(),d>=f[0]&&d<=f[1])return t.placedWalls.splice(t.placedWalls.length-1,1),!0;for(e=k(d,!1,!0),c=0;c<e.length;c++)1!==h[e[c]]&&(h[e[c]]=1,g=g.concat(k(e[c],!1,!0)))}while(g.length>0);return t.placedWalls.splice(t.placedWalls.length-1,1),!1}function j(a){var b,c;for(b=players.getTokens(),c=0;c<b.length;c++)if(a===b[c].getPosition())return b[c];return void 0}function k(a,b,c,d){var e,f,g,h,i,r,s,u=q(a),v=m(a,!1);for(e=0;e<v.length;e++)t.placedWalls.indexOf(v[e])>-1&&(s=p(a,v[e]),u.splice(u.indexOf(n(a,s)),1));if(b===!1)for(e=0;e<u.length;e++)if("undefined"!=typeof j(u[e])&&u[e]!==a){for(i=o(a,u[e]),v=m(u[e],!1),f=0;f<v.length;f++)s=p(u[e],v[f]),i===s&&(r=k(u[e],!0,!0));if("undefined"==typeof r&&(h=n(u[e],i),h>-1?u.splice(e,1,h):r=k(u[e],!0,!0)),"undefined"!=typeof r){for(g=0;g<r.length;g++)-1===u.indexOf(r[g])&&u.push(r[g]);u.splice(e,1)}}return d&&u.splice(u.indexOf(a),1),c===!0?u:void l(u)}function l(a){a.constructor===Array?t.validMoves=a.slice():t.validMoves=[]}function m(a,b){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=s(a),g=f.slice(),h=c(a),i=[];for(e=0;e<h.length;e++)switch(h[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(b===!0)return g;for(e=0;e<g.length;e++)-1===t.placedWalls.indexOf(g[e])&&i.push(g[e]);for(e=0;e<i.length;e++)g.splice(g.indexOf(i[e]),1);return g}function n(a,b){var c=[a-gameSpecs.BOARD_DIMENSION,a+1,a+gameSpecs.BOARD_DIMENSION,a-1];return d(a,c[b])?c[b]:-1}function o(a,b){var c,d=r(a);for(c=0;c<d.length;c++)if(d[c]===b)return c;return-1}function p(a,b){var c,d=s(a);for(c=0;c<d.length;c++)if(d[c]===b)switch(c){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function q(a){var b,d=r(a),e=d.slice(),f=c(a);for(b=0;b<f.length;b++)e.splice(e.indexOf(d[f[b]]),1);return e}function r(a){return[a-gameSpecs.BOARD_DIMENSION,a+1,a+gameSpecs.BOARD_DIMENSION,a-1,a]}function s(a){var b,c=[];return b=a%gameSpecs.BOARD_DIMENSION*2+Math.floor(a/gameSpecs.BOARD_DIMENSION)*(gameSpecs.BOARD_DIMENSION-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(gameSpecs.BOARD_DIMENSION-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}var t={};return b(),{placeWall:function(a){a>-1&&t.placedWalls.push(a)},getBoardString:function(){return JSON.stringify({dimension:gameSpecs.BOARD_DIMENSION,totalWalls:128,placedWalls:t.placedWalls,validMoves:k(players.getCurrentPlayer().getToken().getPosition(),!1,!0,!0),currentPlayer:players.getCurrentPlayer().getName(),player1:{position:players.getToken("player1").getPosition(),winRange:players.getToken("player1").getWinRange(),wallCount:players.getPlayer("player1").getWallCount()},player2:{position:players.getToken("player2").getPosition(),winRange:players.getToken("player2").getWinRange(),wallCount:players.getPlayer("player2").getWallCount()}})},getValidMoves:function(){return t.validMoves},setValidMoves:l,findValidMoves:k,wallIsValid:f,moveIsValid:g,getPlacedWalls:function(){return t.placedWalls}}}var ai=function(){"use strict";function a(a){}io("http://localhost:9000");return{getMove:a}}(),board,GUI=function(){"use strict";function a(a){var b=gameSpecs.BORDER_WIDTH+gameSpecs.CELL_WIDTH,c=0,d=a[0]%b<=gameSpecs.BORDER_WIDTH,e=a[1]%b<=gameSpecs.BORDER_WIDTH,f=a[0]>gameSpecs.BORDER_WIDTH&&a[1]>gameSpecs.BORDER_WIDTH,g=Math.floor(a[0]/b)<gameSpecs.BOARD_DIMENSION&&Math.floor(a[1]/b)<gameSpecs.BOARD_DIMENSION;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>gameSpecs.BORDER_WIDTH?c+=2*Math.floor(a[1]/b)*(gameSpecs.BOARD_DIMENSION-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(gameSpecs.BOARD_DIMENSION-1)),Math.floor(a[0]/b)<gameSpecs.BOARD_DIMENSION&&(c+=a[0]%b>gameSpecs.BORDER_WIDTH?2*Math.floor(a[0]/b):2*Math.floor(a[0]/b)-1),Math.floor(a[0]/b)===gameSpecs.BOARD_DIMENSION-1&&a[0]%b>gameSpecs.BORDER_WIDTH?c-=2:Math.floor(a[1]/b)===gameSpecs.BOARD_DIMENSION-1&&a[1]%b>gameSpecs.BORDER_WIDTH&&(c-=2*(gameSpecs.BOARD_DIMENSION-1)),c):d&&e&&j.wallPreview>-1?j.wallPreview:-1}function b(a){var b,c,d=gameSpecs.BORDER_WIDTH+gameSpecs.CELL_WIDTH;return a%2===0?(b=gameSpecs.BORDER_WIDTH+a%(2*(gameSpecs.BOARD_DIMENSION-1))/2*d,c=(1+Math.floor(a/(2*(gameSpecs.BOARD_DIMENSION-1))))*d):(b=((a%(2*(gameSpecs.BOARD_DIMENSION-1))-1)/2+1)*d,c=gameSpecs.BORDER_WIDTH+Math.floor(a/(2*(gameSpecs.BOARD_DIMENSION-1)))*d),[b,c]}function c(a){var b=a%gameSpecs.BOARD_DIMENSION,c=Math.floor(a/gameSpecs.BOARD_DIMENSION),d=b*gameSpecs.CELL_WIDTH+(b+1)*gameSpecs.BORDER_WIDTH,e=c*gameSpecs.CELL_WIDTH+(c+1)*gameSpecs.BORDER_WIDTH;return[d,e]}function d(){var a,b=[],d=board.getValidMoves();if("undefined"==typeof d)return void 0;for(a=0;a<d.length;a++)b.push(c(d[a]));return b}function e(){var a,b,c,d=players.getPlayer("player1").getWallCount(),e=players.getPlayer("player2").getWallCount();for(j.hudContext.fillStyle="black",j.hudContext.fillRect(0,0,gameSpecs.BOARD_SIZE/3,gameSpecs.BOARD_SIZE),c=0;e>c;c++)a=gameSpecs.BORDER_WIDTH+c%5*2*gameSpecs.BORDER_WIDTH,b=2.5*gameSpecs.CELL_WIDTH*(.3+Math.floor(c/5)),f([a,b],j.hudContext,players.getPlayer("player2").getColor(),!0);for(c=0;d>c;c++)a=gameSpecs.BORDER_WIDTH+c%5*2*gameSpecs.BORDER_WIDTH,b=5*gameSpecs.CELL_WIDTH+2.5*gameSpecs.CELL_WIDTH*(.3+Math.floor(c/5)),f([a,b],j.hudContext,players.getPlayer("player1").getColor(),!0)}function f(a,b,c,d){b.fillStyle=c,d===!0?b.fillRect(a[0],a[1],gameSpecs.BORDER_WIDTH,2*gameSpecs.CELL_WIDTH+gameSpecs.BORDER_WIDTH):b.fillRect(a[0],a[1],2*gameSpecs.CELL_WIDTH+gameSpecs.BORDER_WIDTH,gameSpecs.BORDER_WIDTH)}function g(a){var b=a.getX(),c=a.getY(),d=a.getRadius();j.boardContext.fillStyle=a.getColor(),j.boardContext.beginPath(),j.boardContext.arc(b,c,d,0,2*Math.PI),j.boardContext.fill()}function h(){function a(a,b){j.boardContext.fillStyle=b,j.boardContext.fillRect(a[0],a[1],gameSpecs.CELL_WIDTH,gameSpecs.CELL_WIDTH)}var c,e,h,i,k,l,m,n,o=board.getPlacedWalls();for(j.boardContext.fillStyle="black",j.boardContext.fillRect(0,0,gameSpecs.BOARD_SIZE,gameSpecs.BOARD_SIZE),c=0;c<gameSpecs.BOARD_DIMENSION;c++)for(e=0;e<gameSpecs.BOARD_DIMENSION;e++)if(i=gameSpecs.BORDER_WIDTH*(e+1)+gameSpecs.CELL_WIDTH*e,k=gameSpecs.BORDER_WIDTH*(c+1)+gameSpecs.CELL_WIDTH*c,n=d(),"undefined"!=typeof n){for(h=0;h<n.length;h++)n[h][0]===i&&n[h][1]===k&&(a([i,k],"#D8D8D8"),h=n.length+1);h===n.length&&a([i,k],"grey")}else a([i,k],"grey");if(j.wallPreview>-1&&(l=b(j.wallPreview),j.wallPreview%2===0?f(l,j.boardContext,players.getCurrentPlayer().getColor(),!1):f(l,j.boardContext,players.getCurrentPlayer().getColor(),!0)),o.length>0)for(c=0;c<o.length;c++)l=b(o[c]),o[c]%2===0?f(l,j.boardContext,"white",!1):f(l,j.boardContext,"white",!0);m=players.getTokens(),g(m[0]),g(m[1])}function i(){h(),e()}var j={};return{init:function(){j.hudCanvas=document.createElement("canvas"),j.hudCanvas.id="hud",j.hudCanvas.height=gameSpecs.BOARD_SIZE,j.hudCanvas.width=gameSpecs.BOARD_SIZE/3,j.hudContext=j.hudCanvas.getContext("2d"),j.hudContext.fillStyle="black",j.hudContext.fillRect(0,0,gameSpecs.BOARD_SIZE/3,gameSpecs.BOARD_SIZE),document.body.appendChild(j.hudCanvas),j.boardCanvas=document.createElement("canvas"),j.boardCanvas.id="board",j.boardCanvas.height=gameSpecs.BOARD_SIZE,j.boardCanvas.width=gameSpecs.BOARD_SIZE,j.boardContext=j.boardCanvas.getContext("2d"),j.boardContext.fillStyle="black",j.boardContext.fillRect(0,0,gameSpecs.BOARD_SIZE,gameSpecs.BOARD_SIZE),document.body.appendChild(j.boardCanvas),j.wallPreview=-1,i()},update:i,getBoardCanvas:function(){return j.boardCanvas},getBoardContext:function(){return j.boardContext},coordinatesToCellPosition:function(a){var b,c,d=gameSpecs.BORDER_WIDTH+gameSpecs.CELL_WIDTH,e=Math.floor(a[0]/d)+Math.floor(a[1]/d)*gameSpecs.BOARD_DIMENSION;for(c=0;2>c;c++)if(b=a[c]%d,b<=gameSpecs.BORDER_WIDTH)return void 0;return e},coordinatesToWallIndex:a,positionToCellCoordinates:function(a){var b=a%gameSpecs.BOARD_DIMENSION,c=Math.floor(a/gameSpecs.BOARD_DIMENSION),d=(b+.5)*gameSpecs.CELL_WIDTH+(b+1)*gameSpecs.BORDER_WIDTH,e=(c+.5)*gameSpecs.CELL_WIDTH+(c+1)*gameSpecs.BORDER_WIDTH;return[d,e]},getWallPreview:function(){return j.wallPreview},setWallPreview:function(a){a>-1?j.wallPreview=a:j.wallPreview=-1},positionToRectCellCoordinates:c,getValidMoveCoordinates:d}}(),gameSpecs={};!function(){"use strict";function a(a){var b=GUI.getBoardCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*GUI.getBoardCanvas().width,d=(a.clientY-b.top)/(b.bottom-b.top)*GUI.getBoardCanvas().height;return[c,d]}gameSpecs.BOARD_DIMENSION=9,gameSpecs.CELL_WIDTH=55,gameSpecs.BORDER_WIDTH=gameSpecs.CELL_WIDTH/5,gameSpecs.BOARD_SIZE=gameSpecs.CELL_WIDTH*gameSpecs.BOARD_DIMENSION+gameSpecs.BORDER_WIDTH*(gameSpecs.BOARD_DIMENSION+1),gameSpecs.TOP_START_POS=Math.floor(gameSpecs.BOARD_DIMENSION/2),gameSpecs.BOT_START_POS=Math.floor(gameSpecs.BOARD_DIMENSION/2)+gameSpecs.BOARD_DIMENSION*(gameSpecs.BOARD_DIMENSION-1),document.addEventListener("DOMContentLoaded",function(){var b,c,d;board=boardConstructor(),players.init(),GUI.init(),console.log("board: "+board.getBoardString()),GUI.getBoardCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l;f=a(e),g=f[0],h=f[1],i=players.getCurrentPlayer().getToken(),j=g-i.getX(),k=h-i.getY(),j*j+k*k<=Math.pow(i.getRadius(),2)&&(b=i,d=j,c=k),l=GUI.getWallPreview(),"undefined"!=typeof b?(board.findValidMoves(b.getPosition(),!1,!1),GUI.update()):board.wallIsValid(l)&&(board.placeWall(l),players.getCurrentPlayer().act(),players.getCurrentPlayer().useWall(),GUI.update())}),GUI.getBoardCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);"undefined"!=typeof b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):GUI.setWallPreview(GUI.coordinatesToWallIndex(h)),GUI.update()}),GUI.getBoardCanvas().addEventListener("mouseup",function(a){"undefined"!=typeof b&&(b.updatePosition(),b.updateCoordinates(),b=void 0,board.setValidMoves([]),GUI.update()),players.getCurrentPlayer().hasActed()&&players.nextPlayer()})})}();var players=function(){"use strict";function a(){return[g.player1.getToken(),g.player2.getToken()]}function b(a){return 0===Math.floor(a/gameSpecs.BOARD_DIMENSION)?[gameSpecs.BOARD_DIMENSION*(gameSpecs.BOARD_DIMENSION-1),Math.pow(gameSpecs.BOARD_DIMENSION,2)-1]:[0,gameSpecs.BOARD_DIMENSION-1]}function c(a,b,c){var d={name:b,color:a,token:new f(a,this,c),hasActed:!1,wallCount:g.startingWalls};this.getName=function(){return d.name},this.getToken=function(){return console.log("get token"),d.token},this.getColor=function(){return d.color},this.act=function(){d.hasActed=!d.hasActed},this.hasActed=function(){return d.hasActed},this.getWallCount=function(){return d.wallCount},this.useWall=function(){d.wallCount--}}function d(a,b,d){c.apply(this,arguments)}function e(a,b,d){c.apply(this,arguments)}function f(a,c,d){var e={position:d,color:a,player:c,winRange:b(d)},f=GUI.positionToCellCoordinates(e.position);e.x=f[0],e.y=f[1],e.radius=gameSpecs.CELL_WIDTH/2*.8,this.getX=function(){return e.x},this.getY=function(){return e.y},this.setX=function(a){e.x=a},this.setY=function(a){e.y=a},this.setPosition=function(a){e.position=a},this.getRadius=function(){return e.radius},this.setCoordinates=function(a){e.x=a[0],e.y=a[1]},this.getCoordinates=function(){return[e.x,e.y]},this.updatePosition=function(){var a,b=[e.x,e.y];a=GUI.coordinatesToCellPosition(b),a!==e.position&&board.moveIsValid(a)&&(e.player.act(),e.position=a)},this.updateCoordinates=function(){var a=GUI.positionToCellCoordinates(e.position);e.x=a[0],e.y=a[1]},this.getPosition=function(){return e.position},this.getWinRange=function(){return e.winRange},this.getColor=function(){return e.color}}var g={player1:void 0,player2:void 0,currentPlayer:void 0,startingWalls:10};return{init:function(){g.player1=new d("red","player1",gameSpecs.BOT_START_POS),g.player2=new e("blue","player2",gameSpecs.TOP_START_POS),g.currentPlayer=g.player1},getPlayer:function(a){return g[a]},getToken:function(a){return g[a].getToken()},getTokens:a,getCurrentPlayer:function(){return g.currentPlayer},nextPlayer:function(){g.currentPlayer.act(),g.currentPlayer=g.currentPlayer===g.player1?g.player2:g.player1}}}();