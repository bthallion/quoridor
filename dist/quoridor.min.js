/* quoridor 24-08-2015 */
var ai=function(){"use strict"}(),board=function(){"use strict";function a(a){var b=a%d.boardDimension,c=Math.floor(a/d.boardDimension);return[b,c]}function b(a){var b=a[0]*d.cellWidth+(a[0]+1)*d.borderWidth,c=a[1]*d.cellWidth+(a[1]+1)*d.borderWidth;return[b,c]}function c(){var a,b,c,e,f,g;for(d.boardContext.fillStyle="black",d.boardContext.fillRect(0,0,d.boardSize,d.boardSize),a=0;a<d.boardDimension;a++)for(b=0;b<d.boardDimension;b++)if(e=d.borderWidth*(b+1)+d.cellWidth*b,f=d.borderWidth*(a+1)+d.cellWidth*a,d.validMoves){for(c=0;c<d.validMoves.length;c++)if(d.validMoves[c][0]===e&&d.validMoves[c][1]===f){d.boardContext.drawImage(d.cellImg[1],e,f),c=d.validMoves.length+1;break}c===d.validMoves.length&&d.boardContext.drawImage(d.cellImg[0],e,f)}else d.boardContext.drawImage(d.cellImg[0],e,f);g=players.getTokens(),g&&(g[0].drawToken(d.boardContext),g[1].drawToken(d.boardContext))}var d={wallImg:[],cellImg:[],placedWalls:[]};return{init:function(a,b){function e(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=d.cellWidth,e=document.createElement("img"),f=d.borderWidth;b.fillStyle="grey",b.fillRect(0,0,c,c),e.src=a.toDataURL(),d.cellImg[0]=e,e=document.createElement("img"),b.fillStyle="#D8D8D8",b.fillRect(0,0,c,c),e.src=a.toDataURL(),d.cellImg[1]=e,e=document.createElement("img"),b.fillStyle="white",b.clearRect(0,0,c,c),b.fillRect(0,0,c,f),e.src=a.toDataURL(),d.wallImg[0]=e,e=document.createElement("img"),b.clearRect(0,0,c,f),b.fillRect(0,0,f,c),e.src=a.toDataURL(),d.wallImg[1]=e}d.cellWidth=a,d.boardDimension=b,d.borderWidth=a/6,d.topStartPos=[Math.floor(d.boardDimension/2),0],d.botStartPos=[Math.floor(d.boardDimension/2),d.boardDimension-1],d.boardSize=d.cellWidth*d.boardDimension+d.borderWidth*(d.boardDimension+1),d.hudCanvas=document.createElement("canvas"),d.hudCanvas.id="hud",d.hudCanvas.height=d.boardSize,d.hudCanvas.width=d.boardSize/3,d.hudContext=d.hudCanvas.getContext("2d"),d.hudContext.fillStyle="black",d.hudContext.fillRect(0,0,d.boardSize/3,d.boardSize),document.body.appendChild(d.hudCanvas),d.boardCanvas=document.createElement("canvas"),d.boardCanvas.id="board",d.boardCanvas.height=d.boardSize,d.boardCanvas.width=d.boardSize,d.boardContext=d.boardCanvas.getContext("2d"),d.boardContext.fillStyle="black",d.boardContext.fillRect(0,0,d.boardSize,d.boardSize),document.body.appendChild(d.boardCanvas),e(),d.cellImg[0].onload=c},drawBoard:c,positionIndexToPosition:a,getCanvas:function(){return d.boardCanvas},getContext:function(){return d.boardContext},getDimension:function(){return d.boardDimension},getCellWidth:function(){return d.cellWidth},getBorderWidth:function(){return d.borderWidth},getBotPos:function(){return d.botStartPos},getTopPos:function(){return d.topStartPos},coordinatesToPosition:function(a){var b,c,e=d.borderWidth+d.cellWidth,f=Math.floor(a[0]/e),g=Math.floor(a[1]/e);for(c=0;2>c;c++)if(b=a[c]%e,b<=d.borderWidth)return void 0;return[f,g]},positionToCoordinates:function(a){var b=(a[0]+.5)*d.cellWidth+(a[0]+1)*d.borderWidth,c=(a[1]+.5)*d.cellWidth+(a[1]+1)*d.borderWidth;return[b,c]},positionToRectCoordinates:b,setValidMoves:function(c){var e,f=[];if(c){for(e=0;e<c.length;e++)f.push(b(a(c[e])));d.validMoves=f}else d.validMoves=void 0},findValidMoves:function(a){var b,c,e,f,g,h=[a,a-1,a+1,a+d.boardDimension,a-d.boardDimension],i=[],j=!1,k=!1;for(b=a%d.boardDimension*2,c=a%d.boardDimension*2+1,b+=Math.floor(a/d.boardDimension)*(d.boardDimension-1)*2,c+=Math.floor(a/d.boardDimension)*(d.boardDimension-1)*2,a%d.boardDimension<8?Math.floor(a/d.boardDimension)<8?i.push(b,c):(g=h.indexOf(a+d.boardDimension),g>-1&&h.splice(g,1)):(g=h.indexOf(a+1),g>-1&&h.splice(g,1)),b-=2,c-=2,a%d.boardDimension>0?Math.floor(a/d.boardDimension)<8&&i.push(b,c):(g=h.indexOf(a-1),g>-1&&h.splice(g,1)),b-=2*(d.boardDimension-1),c-=2*(d.boardDimension-1),a%d.boardDimension>0&&(Math.floor(a/d.boardDimension)>0?i.push(b,c):(g=h.indexOf(a-d.boardDimension),g>-1&&h.splice(g,1))),b+=2,c+=2,a%d.boardDimension<8?Math.floor(a/d.boardDimension)>0?i.push(b,c):(g=h.indexOf(a-d.boardDimension),g>-1&&h.splice(g,1)):(g=h.indexOf(a+1),g>-1&&h.splice(g,1)),e=0;e<i.length;e++)if(d.placedWalls.indexOf(i[e])>-1){for(f=0;f<i.length;f++)Math.floor(i[e]/(d.boardDimension-1))<Math.floor(i[f]/(d.boardDimension-1))&&(j=!0),i[e]+2===i[f]&&(k=!0);i[e]%2===0?j?(g=h.indexOf(a-d.boardDimension),g>-1&&h.splice(g,1)):(g=h.indexOf(a+d.boardDimension),g>-1&&h.splice(g,1)):k?(g=h.indexOf(a-1),g>-1&&h.splice(g,1)):(g=h.indexOf(a+1),g>-1&&h.splice(g,1))}for(e=0;e<h.length;e++)players.getTokenAtPositionIndex(h[e])&&players.getTokenAtPositionIndex(a)!==players.getTokenAtPositionIndex(h[e]);return console.log("moves "+h),h}}}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){function a(a){var b=a.clientX-a.target.offsetLeft,c=a.clientY-a.target.offsetTop;return[b,c]}var b,c,d;board.init(55,9),players.init("human","ai"),board.getCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l,m;for(f=a(e),g=f[0],h=f[1],i=players.getTokens(),j=0;j<i.length;j++)if(k=g-i[j].getX(),l=h-i[j].getY(),k*k+l*l<=Math.pow(i[j].getRadius(),2)){b=i[j],d=k,c=l;break}m=board.findValidMoves(b.getPositionIndex()),board.setValidMoves(m),board.drawBoard()}),board.getCanvas().addEventListener("mousemove",function(e){var f,g,h;b&&(f=a(e),g=f[0]-d,h=f[1]-c,b.setCoordinates([g,h]),board.drawBoard())}),board.getCanvas().addEventListener("mouseup",function(a){b&&(b.updatePosition(),b.updateCoordinates(),board.setValidMoves(void 0),board.drawBoard(),b=void 0)})})}();var players=function(){"use strict";function a(){return[f.player1.getToken(),f.player2.getToken()]}function b(a,b){var c={currentPlayer:!1,token:new e(b,a,this)};this.currentPlayer=function(){return c.currentPlayer},this.getToken=function(){return c.token}}function c(a,c){b.apply(this,arguments)}function d(a,c){b.apply(this,arguments)}function e(a,b,c){var d={position:a,color:b,player:c},e=board.getCellWidth();d.x=(d.position[0]+.5)*e+(d.position[0]+1)*board.getBorderWidth(),d.y=(d.position[1]+.5)*e+(d.position[1]+1)*board.getBorderWidth(),d.radius=e/2*.8,this.drawToken=function(a){a.fillStyle=d.color,a.beginPath(),a.arc(d.x,d.y,d.radius,0,2*Math.PI),a.fill()},this.getX=function(){return d.x},this.getY=function(){return d.y},this.setX=function(a){d.x=a},this.setY=function(a){d.y=a},this.setPosition=function(a){d.position=a},this.getRadius=function(){return d.radius},this.setCoordinates=function(a){d.x=a[0],d.y=a[1]},this.getCoordinates=function(){return[d.x,d.y]},this.updatePosition=function(){var a=[d.x,d.y];d.position=board.coordinatesToPosition(a)},this.updateCoordinates=function(){var a=board.positionToCoordinates(d.position);d.x=a[0],d.y=a[1]},this.getPositionIndex=function(){return d.position[0]+d.position[1]*board.getDimension()}}var f={player1:void 0,player2:void 0};return{init:function(a,b){function e(a,b,e){return"human"===a?new c(b,e):new d(b,e)}f.player1=e(a,"red",board.getBotPos()),f.player2=e(b,"blue",board.getTopPos())},getPlayer1:function(){return f.player1},getPlayer2:function(){return f.player2},getTokens:a,getTokenAtPositionIndex:function(b){var c,d=a();for(c=0;c<d.length;c++)if(b===d[c].getPositionIndex())return d[c];return void 0}}}();