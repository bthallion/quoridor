/* quoridor 27-08-2015 */
var ai=function(){"use strict"}(),board=function(){"use strict";function a(a){var b,c=[];return b=a%x.boardDimension*2+Math.floor(a/x.boardDimension)*(x.boardDimension-1)*2,c.push(b,b+1),b-=2,c.push(b,b+1),b-=2*(x.boardDimension-1),c.push(b,b+1),b+=2,c.push(b,b+1),c}function b(a){return[a-x.boardDimension,a+1,a+x.boardDimension,a-1,a]}function c(a){var c,d=b(a),e=d.slice(),f=h(a);for(c=0;c<f.length;c++)e.splice(e.indexOf(d[f[c]]),1);return e}function d(b,c){var d,e=a(b);for(d=0;d<e.length;d++)if(e[d]===c)switch(d){case 4:case 6:return 0;case 1:case 7:return 1;case 0:case 2:return 2;case 3:case 5:return 3}return-1}function e(a,c){var d,e=b(a);for(d=0;d<e.length;d++)if(e[d]===c)return d;return-1}function f(a,b){var c=[a-x.boardDimension,a+1,a+x.boardDimension,a-1];return i(a,c[b])?c[b]:-1}function g(b,c){function d(a){var b,c;for(c=0;c<a.length;c++)b=g.indexOf(f[a[c]]),-1!==b&&g.splice(b,2)}var e,f=a(b),g=f.slice(),i=h(b),j=[];for(e=0;e<i.length;e++)switch(i[e]){case 0:d([4,6]);break;case 1:d([6,0]);break;case 2:d([0,2]);break;case 3:d([2,4])}if(c===!0)return g;for(e=0;e<g.length;e++)-1===x.placedWalls.indexOf(g[e])&&j.push(g[e]);for(e=0;e<j.length;e++)g.splice(g.indexOf(j[e]),1);return g}function h(a){var b,c=[];for(b=0;4>b;b++)-1===f(a,b)&&c.push(b);return c}function i(a,b){var c=e(a,b);switch(c){case 0:return Math.floor(a/x.boardDimension)>0;case 1:return a%x.boardDimension<8;case 2:return Math.floor(a/x.boardDimension)<8;case 3:return a%x.boardDimension>0;default:return!1}}function j(a){var b,c;for(a%2===0?(c=[a,a+1,a+2,a-2],a%(2*(x.boardDimension-1))===2*(x.boardDimension-1)-2&&c.splice(2,1),a%(2*(x.boardDimension-1))===0&&c.splice(3,1)):c=[a,a-1,a-2*(x.boardDimension-1),a+2*(x.boardDimension-1)],b=0;b<c.length;b++)if(x.placedWalls.indexOf(c[b])>-1)return!0;return!1}function k(a){return a>-1&&!j(a)&&m(a)}function l(a){return"undefined"!=typeof x.validMoves?-1!==x.validMoves.indexOf(a):!1}function m(a){var b,c=players.getTokens();for(b=0;b<c.length;b++)if(!n(c[b],a))return!1;return!0}function n(a,b){var c,d,e,f=a.getWinRange(),g=[a.getPosition()],h=new Array(Math.pow(x.boardDimension,2)-1).join("0").split("").map(parseFloat);b>-1&&x.placedWalls.push(b);do{if(d=g.shift(),d>=f[0]&&d<=f[1])return x.placedWalls.splice(x.placedWalls.length-1,1),!0;for(e=o(d,!1),c=0;c<e.length;c++)1!==h[e[c]]&&(h[e[c]]=1,g=g.concat(o(e[c])))}while(g.length>0);return x.placedWalls.splice(x.placedWalls.length-1,1),!1}function o(a,b){var h,i,j,k,l,m,n,p=c(a),q=g(a,!1);for(h=0;h<q.length;h++)x.placedWalls.indexOf(q[h])>-1&&(n=d(a,q[h]),p.splice(p.indexOf(f(a,n)),1));if(b===!1)for(h=0;h<p.length;h++)if("undefined"!=typeof players.getTokenAtPosition(p[h])&&p[h]!==a){for(l=e(a,p[h]),q=g(p[h],!1),i=0;i<q.length;i++)n=d(p[h],q[i]),l===n&&(m=o(p[h],!0));if("undefined"==typeof m&&(k=f(p[h],l),k>-1?p.splice(h,1,k):m=o(p[h],!0)),"undefined"!=typeof m){for(j=0;j<m.length;j++)-1===p.indexOf(m[j])&&p.push(m[j]);p.splice(h,1)}}return p}function p(a){var b=x.borderWidth+x.cellWidth,c=0,d=a[0]%b<=x.borderWidth,e=a[1]%b<=x.borderWidth,f=a[0]>x.borderWidth&&a[1]>x.borderWidth,g=Math.floor(a[0]/b)<x.boardDimension&&Math.floor(a[1]/b)<x.boardDimension;return d!==e&&f&&g?(Math.floor(a[1]/b)>0&&a[1]%b>x.borderWidth?c+=2*Math.floor(a[1]/b)*(x.boardDimension-1):Math.floor(a[1]/b)>0&&(c+=2*(Math.floor(a[1]/b)-1)*(x.boardDimension-1)),Math.floor(a[0]/b)<x.boardDimension&&(c+=a[0]%b>x.borderWidth?2*Math.floor(a[0]/b):2*Math.floor(a[0]/b)-1),Math.floor(a[0]/b)===x.boardDimension-1&&a[0]%b>x.borderWidth?c-=2:Math.floor(a[1]/b)===x.boardDimension-1&&a[1]%b>x.borderWidth&&(c-=2*(x.boardDimension-1)),c):d&&e&&x.wallPreview>-1?x.wallPreview:-1}function q(a){var b,c,d=x.borderWidth+x.cellWidth;return a%2===0?(b=x.borderWidth+a%(2*(x.boardDimension-1))/2*d,c=(1+Math.floor(a/(2*(x.boardDimension-1))))*d):(b=((a%(2*(x.boardDimension-1))-1)/2+1)*d,c=x.borderWidth+Math.floor(a/(2*(x.boardDimension-1)))*d),[b,c]}function r(a){var b=a%x.boardDimension,c=Math.floor(a/x.boardDimension),d=b*x.cellWidth+(b+1)*x.borderWidth,e=c*x.cellWidth+(c+1)*x.borderWidth;return[d,e]}function s(){var a,b=[];if("undefined"==typeof x.validMoves)return void 0;for(a=0;a<x.validMoves.length;a++)b.push(r(x.validMoves[a]));return b}function t(){var a,b,c,d=players.getPlayer1().getWallCount(),e=players.getPlayer2().getWallCount();for(x.hudContext.fillStyle="black",x.hudContext.fillRect(0,0,x.boardSize/3,x.boardSize),c=0;e>c;c++)a=x.borderWidth+c%5*2*x.borderWidth,b=2.5*x.cellWidth*(.3+Math.floor(c/5)),u([a,b],x.hudContext,players.getPlayer2().getColor(),!0);for(c=0;d>c;c++)a=x.borderWidth+c%5*2*x.borderWidth,b=5*x.cellWidth+2.5*x.cellWidth*(.3+Math.floor(c/5)),u([a,b],x.hudContext,players.getPlayer1().getColor(),!0)}function u(a,b,c,d){b.fillStyle=c,d===!0?b.fillRect(a[0],a[1],x.borderWidth,2*x.cellWidth+x.borderWidth):b.fillRect(a[0],a[1],2*x.cellWidth+x.borderWidth,x.borderWidth)}function v(){function a(a,b){x.boardContext.fillStyle=b,x.boardContext.fillRect(a[0],a[1],x.cellWidth,x.cellWidth)}var b,c,d,e,f,g,h,i;for(x.boardContext.fillStyle="black",x.boardContext.fillRect(0,0,x.boardSize,x.boardSize),b=0;b<x.boardDimension;b++)for(c=0;c<x.boardDimension;c++)if(e=x.borderWidth*(c+1)+x.cellWidth*c,f=x.borderWidth*(b+1)+x.cellWidth*b,i=s(),"undefined"!=typeof i){for(d=0;d<i.length;d++)i[d][0]===e&&i[d][1]===f&&(a([e,f],"#D8D8D8"),d=i.length+1);d===i.length&&a([e,f],"grey")}else a([e,f],"grey");if("undefined"!=typeof x.wallPreview&&x.wallPreview>-1&&(g=q(x.wallPreview),x.wallPreview%2===0?u(g,x.boardContext,players.getCurrentPlayer().getColor(),!1):u(g,x.boardContext,players.getCurrentPlayer().getColor(),!0)),x.placedWalls.length>0)for(b=0;b<x.placedWalls.length;b++)g=q(x.placedWalls[b]),x.placedWalls[b]%2===0?u(g,x.boardContext,"white",!1):u(g,x.boardContext,"white",!0);h=players.getTokens(),"undefined"!=typeof h&&(h[0].drawToken(x.boardContext),h[1].drawToken(x.boardContext))}function w(){v(),t()}var x={placedWalls:[]};return{init:function(a,b){x.cellWidth=a,x.boardDimension=b,x.borderWidth=a/5,x.topStartPos=Math.floor(x.boardDimension/2),x.botStartPos=Math.floor(x.boardDimension/2)+x.boardDimension*(x.boardDimension-1),x.boardSize=x.cellWidth*x.boardDimension+x.borderWidth*(x.boardDimension+1),x.hudCanvas=document.createElement("canvas"),x.hudCanvas.id="hud",x.hudCanvas.height=x.boardSize,x.hudCanvas.width=x.boardSize/3,x.hudContext=x.hudCanvas.getContext("2d"),x.hudContext.fillStyle="black",x.hudContext.fillRect(0,0,x.boardSize/3,x.boardSize),document.body.appendChild(x.hudCanvas),x.boardCanvas=document.createElement("canvas"),x.boardCanvas.id="board",x.boardCanvas.height=x.boardSize,x.boardCanvas.width=x.boardSize,x.boardContext=x.boardCanvas.getContext("2d"),x.boardContext.fillStyle="black",x.boardContext.fillRect(0,0,x.boardSize,x.boardSize),document.body.appendChild(x.boardCanvas)},drawBoard:v,updateDisplay:w,getCanvas:function(){return x.boardCanvas},getContext:function(){return x.boardContext},getDimension:function(){return x.boardDimension},getCellWidth:function(){return x.cellWidth},getBorderWidth:function(){return x.borderWidth},getBotPos:function(){return x.botStartPos},getTopPos:function(){return x.topStartPos},coordinatesToCellPosition:function(a){var b,c,d=x.borderWidth+x.cellWidth,e=Math.floor(a[0]/d)+Math.floor(a[1]/d)*x.boardDimension;for(c=0;2>c;c++)if(b=a[c]%d,b<=x.borderWidth)return void 0;return e},coordinatesToWallIndex:p,positionToCellCoordinates:function(a){var b=a%x.boardDimension,c=Math.floor(a/x.boardDimension),d=(b+.5)*x.cellWidth+(b+1)*x.borderWidth,e=(c+.5)*x.cellWidth+(c+1)*x.borderWidth;return[d,e]},positionToRectCellCoordinates:r,setValidMovePositions:function(a){"undefined"!=typeof a?x.validMoves=a.slice():x.validMoves=void 0},getValidMovePositions:function(){return x.validMoves},getValidMoveCoordinates:s,setWallPreview:function(a){a.constructor===Array?x.wallPreview=p(a):x.wallPreview=void 0},getWallPreview:function(){return x.wallPreview>-1?x.wallPreview:void 0},placeWall:function(a){a>-1&&x.placedWalls.push(a)},getAdjacentWalls:g,findValidMovePositions:o,moveIsOnBoard:i,wallIsValid:k,moveIsValid:l}}();!function(){"use strict";document.addEventListener("DOMContentLoaded",function(){function a(a){var b=board.getCanvas().getBoundingClientRect(),c=(a.clientX-b.left)/(b.right-b.left)*board.getCanvas().width,d=(a.clientY-b.top)/(b.bottom-b.top)*board.getCanvas().height;return[c,d]}var b,c,d;board.init(55,9),players.init("human","ai"),board.updateDisplay(),board.getCanvas().addEventListener("mousedown",function(e){var f,g,h,i,j,k,l,m;f=a(e),g=f[0],h=f[1],i=players.getCurrentPlayer().getToken(),j=g-i.getX(),k=h-i.getY(),j*j+k*k<=Math.pow(i.getRadius(),2)&&(b=i,d=j,c=k),m=board.getWallPreview(),"undefined"!=typeof b?(l=board.findValidMovePositions(b.getPosition(),!1),console.log("moves "+l),board.setValidMovePositions(l),board.updateDisplay()):board.wallIsValid(m)&&(board.placeWall(m),players.getCurrentPlayer().act(),players.getCurrentPlayer().useWall(),board.updateDisplay())}),board.getCanvas().addEventListener("mousemove",function(e){var f,g,h=a(e);"undefined"!=typeof b?(f=h[0]-d,g=h[1]-c,b.setCoordinates([f,g])):board.setWallPreview(h),board.updateDisplay()}),board.getCanvas().addEventListener("mouseup",function(a){"undefined"!=typeof b&&(b.updatePosition(),b.updateCoordinates(),b=void 0,board.setValidMovePositions(void 0),board.updateDisplay()),players.getCurrentPlayer().hasActed()&&players.nextPlayer()})})}();var players=function(){"use strict";function a(){return[g.player1.getToken(),g.player2.getToken()]}function b(a){return 0===Math.floor(a/board.getDimension())?[board.getDimension()*(board.getDimension()-1),Math.pow(board.getDimension(),2)-1]:[0,board.getDimension()-1]}function c(a,b,c){var d={color:a,token:new f(b,c,a,this),hasActed:!1,wallCount:g.startingWalls};this.getToken=function(){return d.token},this.getColor=function(){return d.color},this.act=function(){d.hasActed=!d.hasActed},this.hasActed=function(){return d.hasActed},this.getWallCount=function(){return d.wallCount},this.useWall=function(){d.wallCount--,console.log("wall count "+d.wallCount)}}function d(a,b){c.apply(this,arguments)}function e(a,b){c.apply(this,arguments)}function f(a,b,c,d){var e={position:a,color:c,player:d,winRange:b},f=board.getCellWidth(),g=board.positionToCellCoordinates(e.position);e.x=g[0],e.y=g[1],e.radius=f/2*.8,this.drawToken=function(a){a.fillStyle=e.color,a.beginPath(),a.arc(e.x,e.y,e.radius,0,2*Math.PI),a.fill()},this.getX=function(){return e.x},this.getY=function(){return e.y},this.setX=function(a){e.x=a},this.setY=function(a){e.y=a},this.setPosition=function(a){e.position=a},this.getRadius=function(){return e.radius},this.setCoordinates=function(a){e.x=a[0],e.y=a[1]},this.getCoordinates=function(){return[e.x,e.y]},this.updatePosition=function(){var a,b=[e.x,e.y];a=board.coordinatesToCellPosition(b),a!==e.position&&board.moveIsValid(a)&&(e.player.act(),e.position=a)},this.updateCoordinates=function(){var a=board.positionToCellCoordinates(e.position);e.x=a[0],e.y=a[1]},this.getPosition=function(){return e.position},this.getWinRange=function(){return e.winRange}}var g={player1:void 0,player2:void 0,currentPlayer:void 0,startingWalls:10};return{init:function(a,c){function f(a,c,f){return"human"===a?new d(c,f,b(f)):new e(c,f,b(f))}g.player1=f(a,"red",board.getBotPos()),g.player2=f(c,"blue",board.getTopPos()),g.currentPlayer=g.player1},getPlayer1:function(){return g.player1},getPlayer2:function(){return g.player2},getTokens:a,getTokenAtPosition:function(b){var c,d=a();for(c=0;c<d.length;c++)if(b===d[c].getPosition())return d[c];return void 0},getCurrentPlayer:function(){return g.currentPlayer},nextPlayer:function(){g.currentPlayer.act(),g.currentPlayer=g.currentPlayer===g.player1?g.player2:g.player1}}}();